---
title             : "The title"
shorttitle        : "Title"

author: 
  - name          : "Karolina Muszy≈Ñska"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "University of Warsaw, Faculty of Psychology, ul. Stefana Banacha 2D, 02-097 Warsaw, Poland"
    email         : "karolina.muszynska@psych.uw.edu.pl"
    role: # Contributorship roles (e.g., CRediT, https://credit.niso.org/)
      - "Conceptualization"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "XXX"
    affiliation   : "2"
    role:
      - "Writing - Review & Editing"
      - "Supervision"

affiliation:
  - id            : "1"
    institution   : "University of Warsaw, Faculty of Psychology"
  - id            : "2"
    institution   : "Stanford University"

authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  One or two sentences to put the results into a more **general context**.
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : "r-references.bib"

floatsintext      : yes
linenumbers       : yes
draft             : no
mask              : no

figurelist        : no
tablelist         : no
footnotelist      : no

classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, include = FALSE}

library(papaja)
r_refs("r-references.bib")

library(tidyverse)
library(Multilada)
library(here)


```

```{r analysis-preferences}
# Seed for random number generation
set.seed(123)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, echo = F, include = F, warning = F, message = F, out.width="60%")
```


```{r, echo = F}
# Data
source(here("data/polish/data_polish.R"))
source(here("data/english/data_ame_english.R"))
```

# Methods
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Participants
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))
Mention the bilinguals and multilinguals

## Material
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Procedure
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Data analysis


# Results

## Psychometric properties of the two CAT-CDIs

Our first aim was to examine whether CAT-CDIs in American English and Polish demonstrate comparable psychometric properties. To that end, we revisit the psychometric properties reported for the American English CAT-CDI (word production) in Kachergis et al. (2022) and compare those to the data from Polish CAT-CDI (Words and Sentences).

<!-- AmE r values copied from Kachergis et al. 2022 -->
```{r}
cor(by_child_pl$cat_theta, by_child_pl$score_full) # AmE:.86, PL: 0.86
cor(by_child_pl$cat_theta, by_child_pl$full_theta) # AmE: .92, PL: .92
cor(by_child_pl$full_theta, by_child_pl$score_full) # AmE: .95, PL: 0.94
```

We found similarly strong correlations in the two languages between the abilities estimated from CDI-CAT and full CDI scores (American English and Polish: $r$ = .86), the abilities estimated from the CDI-CAT and abilities estimated from full CDI (American English and Polish: $r$ = .92), and the abilities estimated from the full CDI and the full CDI scores (American English: $r$ = .95, Polish: $r$ = `r cor(by_child_pl$full_theta, by_child_pl$score_full)`). The abilities estimated from the CDI-CAT and the full CDI scores were also strongly correlated within individual age groups (see Table \@ref(tab:corr-by-age)).


```{r corr-by-age, include = T}

# TODO:
# 1. merge both tables?
# 2. can we specify place in text where the tables should be placed (rn it seems random)

# English
valid_tab <- prod_s %>% 
  mutate(age_group = cut(age_full, breaks=seq(12,36,3), right=F, include.lowest = T)) %>%
  group_by(age_group) %>%
  summarise(r = cor(fullTheta, catTheta), n=n()) #%>% kableExtra::kable(digits=2)

valid_tab_wide = rbind(round(valid_tab$r, 2), as.character(valid_tab$n))
colnames(valid_tab_wide) = as.character(valid_tab$age_group)
row.names(valid_tab_wide) = c('r ability CAT vs full CDI', 'N')

apa_table(valid_tab_wide, caption="American English: Correlations between ability estimated by CAT-CDI and ability estimated from full CDI by children's age") 

# Polish
age_cor_table <- by_child_pl %>% 
  mutate(age_group = cut(age_CAT, breaks=seq(12,36,3), right=F, include.lowest = T)) %>%
  group_by(age_group) %>%
  summarise(r = cor(full_theta, cat_theta), n=n())

age_cor_table_wide = rbind(round(age_cor_table$r, 2), as.character(age_cor_table$n))
colnames(age_cor_table_wide) = as.character(age_cor_table$age_group)
row.names(age_cor_table_wide) = c('r ability CAT vs full CDI', 'N')

apa_table(age_cor_table_wide, caption = "Polish: Correlations between ability estimated by CAT-CDI and ability estimated from full CDI by children's age")
```


The Polish validation study included `r sum(by_child_pl$lang_group == "multilingual")` data from bi- and multilingual families. Though it is a small group, we decided to explore their correlation coefficients (non-parametric Spearman's rho) and found these were similar to those found for Polish monolingual children (see Table \@ref(tab:corr-by-langgroup) in Supplementary Materials). 

```{r corr-by-langgroup, include = T}

# TODO: 
# 1. the table could use some re-styling (lgs as columns?)
# 2. move to Supplementary (separate .Rmd?)

cor1 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(cat_theta, score_full, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from CDI-CAT ~ full CDI score")

cor2 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(cat_theta, full_theta, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from CDI-CAT ~ ability from full CDI")

cor3 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(full_theta, score_full, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from full CDI ~ full CDI score")

lang_cor_table <- bind_rows(cor1, cor2, cor3)
rm(cor1, cor2, cor3)

apa_table(lang_cor_table, caption = "Supplementary Material: Table S1 - Spearman's correlations for monolingual and multilingual children in the Polish dataset")

```

```{r mse}
# TODO
# 1. Eng values shifted slightly? 

# Polish
by_child_pl <- by_child_pl %>% mutate(sq_err = (full_theta - cat_theta)^2,
                                      full_cat_diff = full_theta - cat_theta)
mean(by_child_pl$sq_err) # 0.19
median(by_child_pl$sq_err) # 0.08
sd(by_child_pl$sq_err) # 0.45

bad_thresh_pl <- mean(by_child_pl$sq_err) + 1.5*sd(by_child_pl$sq_err)
bad_thresh_pl # 0.86

by_child_pl <- by_child_pl %>% mutate(extreme_discrep = 
                                           case_when(
                                                sq_err > bad_thresh_pl ~ "yes",
                                                .default = "no"
                                           ))

table(by_child_pl$extreme_discrep)

# English

# mean squared error
prod_s <- prod_s %>% mutate(sq_err = (fullTheta - catTheta)^2,
                            full_cat_diff = fullTheta - catTheta)

bad_thresh_en <- mean(prod_s$sq_err) + 1.5*sd(prod_s$sq_err) # mean=.55, med = .17

# bad_en <- subset(prod_s, sq_err > bad_thresh_en) # 18 --> 15?
# good_en <- subset(prod_s, sq_err <= bad_thresh_en) # 186 --> 189?

prod_s <- prod_s %>% mutate(extreme_discrep = 
                                           case_when(
                                                sq_err > bad_thresh_en ~ "yes",
                                                .default = "no"
                                           ))

table(prod_s$extreme_discrep)


```

```{r duration_full}

# Polish
mean(by_child_pl$duration_full) # 133892.9 sec
sd(by_child_pl$duration_full) # 980822.7 sec
# sd larger than mean - highly skewed

ecdf_fun <- ecdf(as.numeric(by_child_pl$duration_full))
by_child_pl <- by_child_pl %>%
  mutate(duration_full_percentile = ecdf_fun(duration_full) * 100)

# English
# create and attach duration_full to prod_s

demo <- demo %>% mutate(
     duration_full = lubridate::as.duration(last_modified_full - created_date_full))
prod_s <- merge(prod_s, demo[,c("subject_id", "duration_full")], all.x = T, by = "subject_id")

ecdf_fun <- ecdf(as.numeric(prod_s$duration_full))
prod_s <- prod_s %>%
  mutate(duration_full_percentile = ecdf_fun(duration_full) * 100)

prod_s %>% ggplot(aes(y = duration_full, x = extreme_discrep)) + geom_jitter(alpha = 0.3)
# extreme_discrep cases are scattered across the whole range of durations

```

We also compared the mean squared error between the abilities as estimated by CAT-CDI and from the full CDI. The mean squared error in English was 0.55 (*Mdn* = 0.17, *SD* = 1), and in Polish it was `r mean(by_child_pl$sq_err)` (*Mdn* = `r median(by_child_pl$sq_err)`, *SD* = `r sd(by_child_pl$sq_err)`). We also looked at the children for whom the estimates from the CAT-CDI and full CDI diverged extremely, i.e. their difference between the errors was 1.5 SD from the mean. There were `r sum(prod_s$extreme_discrep == "yes")` such cases (`r round(sum(prod_s$extreme_discrep == "yes")/count(prod_s)*100,2)`%) in the English dataset and `r sum(by_child_pl$extreme_discrep == "yes")` cases (`r round(sum(by_child_pl$extreme_discrep == "yes")/count(prod_s)*100,2)`%) in the Polish dataset. All participants (in both datasets) showed a higher CDI-CAT ability as compared to their ability estimated from the full CDI. All of the Polish participants showing extreme discrepancy completed the full CDI in an unusually short time--their completion times were among the shortest 5% in the sample, meaning 95% of participants took longer. This might suggest their ability estimates from the full CDI may have been underestimated, possibly due to rushed (and/or less attentive responses). In support of this view, their CAT-CDI scores had acceptable measurement errors (<= 0.15 for English, <= 0.1 for Polish), indicating that the CAT-CDI was able to estimate their abilities reliably, in contrast to the full CDI. However, the pattern was not replicated in the English dataset, where only `r sum(by_child_pl$extreme_discrep == "yes" & by_child_pl$duration_full_percentile <= 5)` participants who showed extreme discrepancy also showed very short administrations of the full CDI. 

**NOTE TO US**: Below I'm printing the participants with extreme discrepancies, you can see they vary in age, duration of CAT/full, SE of theta, etc. I myself don't see a pattern here:

```{r, include = T}
extreme_discrep <- prod_s %>% filter(extreme_discrep == "yes") %>% select(-subject_id, duration_full_percentile)
apa_table(extreme_discrep)
```

```{r MSE_without_outliers}


```

We also re-calculated the mean squared error without the cases of extreme discrepancy, which yielded a MSE of XX in English and MSE of XX in Polish.




# Discussion
1. Correlations strong in both languages (overall and in age-bins; in PL: multi and mono correlations similar and strong).   
2. MSE after removing cases with extreme discrepancies.  
3. Extreme discrepancies - in both lgs, we see XXX

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::

`r cite_r("r-references.bib")`
