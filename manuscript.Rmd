---
title             : "The title"
shorttitle        : "Title"

author: 
  - name          : "Karolina Muszy≈Ñska"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "University of Warsaw, Faculty of Psychology, ul. Stefana Banacha 2D, 02-097 Warsaw, Poland"
    email         : "karolina.muszynska@psych.uw.edu.pl"
    role: # Contributorship roles (e.g., CRediT, https://credit.niso.org/)
      - "Conceptualization"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "XXX"
    affiliation   : "2"
    role:
      - "Writing - Review & Editing"
      - "Supervision"

affiliation:
  - id            : "1"
    institution   : "University of Warsaw, Faculty of Psychology"
  - id            : "2"
    institution   : "Stanford University"

authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.

  Enter author note here.

abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  One or two sentences to put the results into a more **general context**.
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : "r-references.bib"

floatsintext      : yes
linenumbers       : yes
draft             : no
mask              : no

figurelist        : no
tablelist         : no
footnotelist      : no

classoption       : "man"
output            : papaja::apa6_pdf
---

```{r setup, include = FALSE}

library(papaja)
r_refs("r-references.bib")

library(tidyverse)
library(Multilada)
library(here)


```

```{r analysis-preferences}
# Seed for random number generation
set.seed(123)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, echo = F, include = F, warning = F, message = F, out.width="100%")
```


```{r, echo = F}
# Data
source(here("data/polish/data_polish.R"))
source(here("data/english/data_ame_english.R"))
```

# Methods
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Participants
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))
Mention the bilinguals and multilinguals

## Material
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Procedure
(to paste from [google doc](https://docs.google.com/document/d/1MPInUTyY2Y81EtiiK0tUOo8vG3zowfqiXjpBF0p8Mzs/edit?tab=t.0))

## Data analysis


# Results

## Psychometric properties of the two CAT-CDIs

Our first aim was to examine whether CAT-CDIs in American English and Polish demonstrate comparable psychometric properties. To that end, we revisit the psychometric properties reported for the American English CAT-CDI (word production) in Kachergis et al. (2022) and compare those to the data from Polish CAT-CDI (Words and Sentences).

<!-- AmE r values copied from Kachergis et al. 2022 -->
```{r}
cor(by_child_pl$cat_theta, by_child_pl$score_full) # AmE:.86, PL: 0.86
cor(by_child_pl$cat_theta, by_child_pl$full_theta) # AmE: .92, PL: .92
cor(by_child_pl$full_theta, by_child_pl$score_full) # AmE: .95, PL: 0.94
```

We found similarly strong correlations in the two languages between the abilities estimated from CDI-CAT and full CDI scores (American English and Polish: $r$ = .86), the abilities estimated from the CDI-CAT and abilities estimated from full CDI (American English and Polish: $r$ = .92), and the abilities estimated from the full CDI and the full CDI scores (American English: $r$ = .95, Polish: $r$ = `r cor(by_child_pl$full_theta, by_child_pl$score_full)`). The abilities estimated from the CDI-CAT and the full CDI scores were also strongly correlated within individual age groups (see Table \@ref(tab:corr-by-age)).


```{r corr-by-age, include = T}

# TODO:
# 1. merge both tables?
# 2. can we specify place in text where the tables should be placed (rn it seems random)

# English
valid_tab <- prod_s %>% 
  mutate(age_group = cut(age_full, breaks=seq(12,36,3), right=F, include.lowest = T)) %>%
  group_by(age_group) %>%
  summarise(r = cor(fullTheta, catTheta), n=n()) #%>% kableExtra::kable(digits=2)

valid_tab_wide = rbind(round(valid_tab$r, 2), as.character(valid_tab$n))
colnames(valid_tab_wide) = as.character(valid_tab$age_group)
row.names(valid_tab_wide) = c('r ability CAT vs full CDI', 'N')

apa_table(valid_tab_wide, caption="American English: Correlations between ability estimated by CAT-CDI and ability estimated from full CDI by children's age", placement = "H") 

# Polish
age_cor_table <- by_child_pl %>% 
  mutate(age_group = cut(age_CAT, breaks=seq(12,36,3), right=F, include.lowest = T)) %>%
  group_by(age_group) %>%
  summarise(r = cor(full_theta, cat_theta), n=n())

age_cor_table_wide = rbind(round(age_cor_table$r, 2), as.character(age_cor_table$n))
colnames(age_cor_table_wide) = as.character(age_cor_table$age_group)
row.names(age_cor_table_wide) = c('r ability CAT vs full CDI', 'N')

apa_table(age_cor_table_wide, caption = "Polish: Correlations between ability estimated by CAT-CDI and ability estimated from full CDI by children's age", placement = "H")
```


The Polish validation study included `r sum(by_child_pl$lang_group == "multilingual")` data from bi- and multilingual families. Though it is a small group, we decided to explore their correlation coefficients (non-parametric Spearman's rho) and found these were similar to those found for Polish monolingual children (see Table \@ref(tab:corr-by-langgroup) in Supplementary Materials). 

```{r corr-by-langgroup, include = T}

# TODO: 
# 1. the table could use some re-styling (lgs as columns?)
# 2. move to Supplementary (separate .Rmd?)

cor1 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(cat_theta, score_full, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from CDI-CAT ~ full CDI score")

cor2 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(cat_theta, full_theta, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from CDI-CAT ~ ability from full CDI")

cor3 <- by_child_pl %>%
  group_by(lang_group) %>%
  summarise(r = cor(full_theta, score_full, method = "spearman"), n = n()) %>%
  mutate(correlation = "Ability from full CDI ~ full CDI score")

lang_cor_table <- bind_rows(cor1, cor2, cor3)
rm(cor1, cor2, cor3)

apa_table(lang_cor_table, caption = "Supplementary Material: Table S1 - Spearman's correlations for monolingual and multilingual children in the Polish dataset", placement = "H")

```

```{r mse}
# TODO
# 1. Eng values shifted slightly? 

# Polish
by_child_pl <- by_child_pl %>% mutate(sq_err = (full_theta - cat_theta)^2,
                                      full_cat_diff = full_theta - cat_theta)
mean(by_child_pl$sq_err) # 0.19
median(by_child_pl$sq_err) # 0.08
sd(by_child_pl$sq_err) # 0.45

bad_thresh_pl <- mean(by_child_pl$sq_err) + 1.5*sd(by_child_pl$sq_err)
bad_thresh_pl # 0.86

by_child_pl <- by_child_pl %>% mutate(extreme_discrep = 
                                           case_when(
                                                sq_err > bad_thresh_pl ~ "yes",
                                                .default = "no"
                                           ))

table(by_child_pl$extreme_discrep)

# English

# mean squared error
prod_s <- prod_s %>% mutate(sq_err = (fullTheta - catTheta)^2,
                            full_cat_diff = fullTheta - catTheta)

bad_thresh_en <- mean(prod_s$sq_err) + 1.5*sd(prod_s$sq_err) # mean=.55, med = .17

# bad_en <- subset(prod_s, sq_err > bad_thresh_en) # 18 --> 15?
# good_en <- subset(prod_s, sq_err <= bad_thresh_en) # 186 --> 189?

prod_s <- prod_s %>% mutate(extreme_discrep = 
                                           case_when(
                                                sq_err > bad_thresh_en ~ "yes",
                                                .default = "no"
                                           ))

table(prod_s$extreme_discrep)


```

```{r duration-full}

# Polish
mean(by_child_pl$duration_full) # 133892.9 sec
sd(by_child_pl$duration_full) # 980822.7 sec
# sd larger than mean - highly skewed

ecdf_fun <- ecdf(as.numeric(by_child_pl$duration_full))
by_child_pl <- by_child_pl %>%
  mutate(duration_full_percentile = ecdf_fun(duration_full) * 100)

# English
# create and attach duration_full to prod_s

demo <- demo %>% mutate(
     duration_full = lubridate::as.duration(last_modified_full - created_date_full))
prod_s <- merge(prod_s, demo[,c("subject_id", "duration_full")], all.x = T, by = "subject_id")

ecdf_fun <- ecdf(as.numeric(prod_s$duration_full))
prod_s <- prod_s %>%
  mutate(duration_full_percentile = ecdf_fun(duration_full) * 100)

prod_s %>% ggplot(aes(y = duration_full, x = extreme_discrep)) + geom_jitter(alpha = 0.3)
# extreme_discrep cases are scattered across the whole range of durations

```

We also looked at the mean squared error between the abilities as estimated by CAT-CDI and from the full CDI. The mean squared error in English was 0.55 (*Mdn* = 0.17, *SD* = 1), and in Polish it was `r mean(by_child_pl$sq_err)` (*Mdn* = `r median(by_child_pl$sq_err)`, *SD* = `r sd(by_child_pl$sq_err)`). We also looked at the children for whom the estimates from the CAT-CDI and full CDI diverged extremely, i.e. their difference between the errors was 1.5 SD from the mean. There were `r sum(prod_s$extreme_discrep == "yes")` such cases (`r round(sum(prod_s$extreme_discrep == "yes")/count(prod_s)*100,2)`%) in the English dataset and `r sum(by_child_pl$extreme_discrep == "yes")` cases (`r round(sum(by_child_pl$extreme_discrep == "yes")/count(prod_s)*100,2)`%) in the Polish dataset. All participants in both datasets showed higher ability estimates on the CDI-CAT compared to the full CDI. If the full CDI is considered the baseline, this suggests that parents may have overestimated their child‚Äôs vocabulary on the CDI-CAT, potentially responding ‚Äúyes ‚Äì produces‚Äù to more items than expected based on full CDI estimates (as suggested by Kachergis, et al. 2022). An alternative explanation is that, for these participants, the full CDI may have underestimated the child‚Äôs true ability. Notably, all Polish participants with large discrepancies completed the full CDI in unusually short times (their completion times were among the shortest 5% in the sample) suggesting their responses may have been rushed or less attentive. This could have led to lower ability estimates from the full CDI. Supporting this interpretation, their CDI-CAT scores had acceptable measurement errors (below or equal to 0.1 for Polish), indicating reliable ability estimation by the CDI-CAT, in contrast to the full CDI. However, this pattern did not appear in the English dataset, where only `r sum(by_child_pl$extreme_discrep == "yes" & by_child_pl$duration_full_percentile <= 5)` participants who showed extreme discrepancy also showed very short administrations of the full CDI. 

```{r, include = T}
# participants with extreme discrepancy in English dataset:
extreme_discrep <- prod_s %>% filter(extreme_discrep == "yes") %>% select(-subject_id, duration_full_percentile)
apa_table(extreme_discrep, landscape = T)
```

```{r}
prod_s %>% filter(extreme_discrep == "no") %>% summarise(mean(sq_err)) # 0.44, was 0.55
by_child_pl %>% filter(extreme_discrep == "no") %>% summarise(mean(sq_err)) # 0.12, was 0.19
```

We also re-calculated the mean squared error without the cases of extreme discrepancy, which yielded a MSE of `r round(prod_s %>% filter(extreme_discrep == "no") %>% summarise(mean(sq_err)),2)` (*Mdn* = `r round(prod_s %>% filter(extreme_discrep == "no") %>% summarise(median(sq_err)),2)`, *SD* = `r round(prod_s %>% filter(extreme_discrep == "no") %>% summarise(sd(sq_err)),2)`) in English and MSE of `r round(by_child_pl %>% filter(extreme_discrep == "no") %>% summarise(mean(sq_err)),2)` (*Mdn* = `r round(by_child_pl %>% filter(extreme_discrep == "no") %>% summarise(median(sq_err)),2)`, *SD* = `r round(by_child_pl %>% filter(extreme_discrep == "no") %>% summarise(sd(sq_err)),2)`) in Polish.

## Item properties in the two CAT-CDIs
Our second aim was to analyze similarities and differences in IRT item properties and item selection in CAT in English and Polish.

There are 679 items in the English CAT-CDI and 666 items in the Polish CAT-CDI. For both sets of items, the items' difficulty and discrimination parameters were calculated using IRT 2 parameter model (these included separate samples, see Kachergis et al. 2022 and Krajewski et al. (in preparation)). An item‚Äôs difficulty indicates the ability level at which there is a 50% probability that a participant will respond correctly. <!-- is that still true of d, not b? --> It includes negative and positive values, with 0 indicating medium difficulty, thus reflecting the range of values of ability, i.e. theta. An item‚Äôs discrimination indicates how well it distinguishes between individuals with slightly different ability levels--especially those near that difficulty point. Of these two parameters, item difficulty is of greater interest to the present paper as it is directly linked to ability and as discrimination power is more about how good the item is at measuring, rather than what it is measuring.<!-- this could potentially go up, into Intro/Methods? -->

```{r diff_across_lgs}
# item difficulty by language 
items_cat_en %>% 
     dplyr::summarise(min(d), max(d), mean(d), median(d), sd(d))

items_cat_pl %>% 
     dplyr::summarise(min(d), max(d), mean(d), median(d), sd(d))

t1 <- apa_print(t.test(items_cat_en$d, items_cat_pl$d))

```

```{r common_items}
# common items - still different mean difficulty?

items_en_pl <- merge(items_cat_pl, items_cat_en, 
                  all.x = T, all.y = T,
                  suffixes = c("_pl","_en"),
                  by = "uni_lemma") %>% filter(!is.na(item) & !is.na(definition))
count(items_en_pl) # 390

t2 <- apa_print(t.test(items_en_pl$d_en, items_en_pl$d_pl, paired = T))
# t = -23.112, df = 389, p-value < 2.2e-16

# visualise
items_en_pl %>% select(uni_lemma, d_pl, d_en) %>% pivot_longer(cols = d_pl:d_en, names_to = "lang", values_to = "d") %>% ggplot(aes(x = lang, y = d, group = lang)) + geom_boxplot() + geom_jitter(alpha = 0.3)

# corr
c <- apa_print(cor.test(items_en_pl$d_pl, items_en_pl$d_en)) # 0.65
```

English items are more difficult than the Polish items, `r t1$full_result` (English: min = `r round(min(items_cat_en$d),2)`, max = `r round(max(items_cat_en$d),2)`, *M* = `r round(mean(items_cat_en$d),2)`, *Mdn* = `r round(median(items_cat_en$d),2)`, *SD* = `r round(sd(items_cat_en$d),2)`; Polish: min = `r round(min(items_cat_pl$d),2)`, max = `r round(max(items_cat_pl$d),2)`, *M* = `r round(mean(items_cat_pl$d),2)`, *Mdn* = `r round(median(items_cat_pl$d),2)`, *SD* = `r round(sd(items_cat_pl$d),2)`). Notably, this was true even for a subset of `r count(items_en_pl)` items common to both languages - these items still proved to be more difficult in English than in Polish: `r t2$full_result`. This difference in mean difficulty may be influenced by the characteristics of the samples used to estimate the IRT models. In English, item difficulty was calculated based on a broader sample of children aged 12‚Äì36 months (spanning the CDI:WG, CDI:WS, and CDI-III), whereas the Polish data came from a sample of narrower age range of 18‚Äì36 months, corresponding to the CDI:WS. As a result, item difficulty in English was estimated using a relatively younger sample, for whom certain items may have been more challenging‚Äîthus appearing more difficult‚Äîcompared to the older Polish sample. Still the item difficulty for common items in the two languages was positively and moderately correlated: `r c$full_result`.

```{r d_by_cdi_category_tab, include = T}
# correlations by cdi semantic category on common words
# spearman because ranked

items_en_pl %>% group_by(category_pl) %>% summarise(
     rho = cor(d_pl, d_en, method = "spearman", use = "complete.obs"),
     n = length(category_pl)) %>% arrange(rho) -> corr_by_category

apa_table(corr_by_category, placement = "H")
```

```{r d-by-cdi-category-fig, fig.width = 10, fig.height = 5, fig.cap = "The relative positioning of the items by semantic category (colored) plotted in the context of the full item pool (grey): (A) English, (B) Polish.", fig.pos = '!h', include = T}

# TODO: adjust order, put "helping_verbs" at the end

# AMERICAN ENGLISH
fig1a <- items_cat_en %>%
ggplot(aes(d, a1))  + 
  geom_point(data = items_cat_en %>%
               select(-category), aes(x = d, y = a1), color = 'grey', size = 0.4) +
  geom_point(aes(color=as.factor(category)), size = 0.4) +
  facet_wrap(~category) +
  xlim(-8, 8) +
  ylim(0,8) +
  labs(x = "Item difficulty (d)", y = "Item discrimination (a1)", title = "(A) English") +
  theme(legend.position = "none")

# TODO: adjust order, put "modal_adverbs" and "prepositions" at the end

# POLISH
fig1b <- items_cat_pl %>%
  mutate(category = case_when(
    category == "descriptive_words (adjectives)" ~ "descriptive_words",
    category == "descriptive_words (adverbs)" ~ "descriptive_words",
    category == "pronouns_demonstrative" ~ "pronouns",
    category == "pronouns_personal" ~ "pronouns",
    .default = category
  )) %>%
  filter(!is.na(category)) %>% # tylko has category == NA
ggplot(aes(d, a1))  + 
  geom_point(data = items_cat_pl %>%
               select(-category), aes(x = d, y = a1), color = 'grey', size = 0.4) +
  geom_point(aes(color=as.factor(category)), size = 0.4) +
  facet_wrap(~category)  +
  xlim(-8, 8) +
  ylim(0,8) +
  labs(x = "Item difficulty (d)", y = "Item discrimination (a1)", title = "(B) Polish") +
  theme(legend.position = "none")

fig1 <- ggarrange(fig1a, fig1b, ncol = 2, nrow = 1)
fig1

```

We also wanted to do check whether items in particular CDI semantic categories show related parameter values across the two languages. We performed a series of Spearman's rank correlations (on the items common to CDI-CATs in Polish and English) for each CDI semantic category (see Table \@ref(tab:d_by_cdi_category_tab)). The rank correlations coefficients vary by category, but for half of the categories the correlations are moderate to strong (0.52 to 0.91). Figure \@ref(fig:d-by-cdi-category-fig) shows the relative positioning of the items by semantic category (colored) plotted in the context of the full item pool (grey) in the two languages. It can be seen from the figure that many categories (e.g., sounds) show a similar distribution of items relative to the whole item pool across Polish and English.



```{r}

```



# Discussion
1. Correlations strong in both languages (overall and in age-bins; in PL: multi and mono correlations similar and strong).   
2. MSE after removing cases with extreme discrepancies.  
3. Extreme discrepancies - mixed results?

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::

`r cite_r("r-references.bib")`
